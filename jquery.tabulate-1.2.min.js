/*
 * jQuery.tabulate Plugin
 * Copyright (C) 2010  Kyle Florence <kyle.florence@gmail.com>

 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
(function($){$.fn.tabulate=function(options){return this.each(function(){var $this=$(this);if(!$this.data("tabulate")){var tabulate=$.extend(true,{},$.tabulate);$this.data("tabulate",tabulate);tabulate.init($this,options);tabulate.toString=function(){return"[object "+this.name+"]"}}})};$.tabulate={count:0,total_pages:1,current_page:1,options:{name:"tabulate",cache_requests:false,results_per_page:[5,10,25],parse_key:function(){return new RegExp(/\{([^{}]+)\}/g)},data:{ajax:{},json:{}},keys:{rows:"rows",columns:"columns",count:"count"},rows:{},columns:{},filters:{limit:0,offset:0},event_handlers:{},error_handlers:{},elements:{$loading:".tabulate-loading",$previous:".tabulate-prev",$next:".tabulate-next",$count:".tabulate-count",$total_pages:".tabulate-total-pages",$current_page:".tabulate-current-page",$results_per_page:".tabulate-results-per-page"},paths:{tabulate:window.location.pathname,theme:"themes/default"}},fragments:{$link:$('<a />'),$image:$('<img />'),$option:$('<option />'),$row:$('<tr class="tabulate-row"></tr>'),$cell:$('<td class="tabulate-cell"></td>'),$content:$('<div class="tabulate-cell-content"></div>'),$table:$('<table class="tabulate-table"></table>'),$head:$('<thead class="tabulate-header"></thead>'),$body:$('<tbody class="tabulate-body"></tbody>'),$foot:$(['<tfoot class="tabulate-footer">','    <tr class="tabulate-row">','        <td class="tabulate-cell clearfix">','            <div class="tabulate-cell-content">','                <div class="tabulate-partition tabulate-partition-first tabulate-pagination">','                    <img class="tabulate-prev" />','                    page <input class="tabulate-current-page" type="text" />','                    of <span class="tabulate-total-pages"></span>','                    <img class="tabulate-next" />','                </div>','                <div class="tabulate-partition tabulate-partition-no-input">','                    <span class="tabulate-count">0</span> total results','                </div>','                <div class="tabulate-partition tabulate-partition-no-input">','                    <div class="tabulate-loading"><span>Loading...</span></div>','                </div>','                <div class="tabulate-partition tabulate-partition-last">','                    <select class="tabulate-results-per-page"></select> results per page','                </div>','            </div>','        </td>','    </tr>','</tfoot>'].join(""))},init:function($wrapper,options){var self=this;$.extend(true,this.options,options||{});$.extend(true,this,this.options);this.$wrapper=$wrapper;this.paths.theme=[this.paths.tabulate,this.paths.theme].join("/");this.filters.limit=this.filters.limit||this.results_per_page[0];this.$table=this.fragments.$table.append(this.$head=this.fragments.$head).append(this.$body=this.fragments.$body).append(this.$foot=this.fragments.$foot);this.$wrapper.append(this.$table).data("tabulate",this);$.each(this.elements,function(key,selector){self.elements[key]=$(selector)});this.elements.$previous.attr({src:this.paths.theme+"/prev.gif",alt:"Previous Page",title:"Previous Page"}).click(function(){self.previous(this);return false});this.elements.$next.attr({src:this.paths.theme+"/next.gif",alt:"Next Page",title:"Next Page"}).click(function(){self.next(this);return false});this.elements.$current_page.keyup(function(event){var page=parseInt($(this).val());if(!isNaN(page)&&event.which==13){self.go_to(this,page)}});this.elements.$results_per_page.change(function(){var limit=parseInt($(this).val());if(!isNaN(limit)){self.update_filters({limit:limit})}});$.each(this.event_handlers,function(name,handler){self.$wrapper.bind([name,self.name].join("."),function(){handler.apply(self,arguments)})});this.trigger("post_init")},previous:function(element){if(this.current_page>1){this.current_page--;this.update_filters({offset:((this.current_page-1)*this.filters.limit)})}},next:function(element){if(this.current_page<this.total_pages){this.current_page++;this.update_filters({offset:((this.current_page-1)*this.filters.limit)})}},go_to:function(element,page){if(page>=1&&page<=this.total_pages){this.current_page=page;this.update_filters({offset:((this.current_page-1)*this.filters.limit)})}},update_filters:function(filters,refresh){$.extend(true,this.filters,filters||{});if(refresh!==false){this.trigger("refresh")}},error:function(name,args){if(this.error_handlers[name]!="undefined"){this.error_handlers[name].apply(this,args||[])}},trigger:function(name,args){this.$wrapper.triggerHandler([name,this.name].join("."),args||[])},set_properties:function($element,properties){if($element&&typeof properties=="object"){var self=this,tag=$element.attr("tagName").toLowerCase();if(tag=="td"){var data=properties.data||{},$content=properties.$content||$element;if(properties.content&&properties.content.length){if(typeof properties.content=="string"){$content.html(properties.content.replace(this.parse_key(),function(str,key){return $.getNestedKey(key,data)||""}))}else if(properties.content instanceof jQuery){$content.append(properties.content)}}}if(typeof properties.styles=="object"){$element.css(properties.styles)}if(typeof properties.callback=="function"){properties.callback.apply(this,properties.args||[])}if(typeof properties.event_handlers=="object"){$.each(properties.event_handlers,function(name,handler){$element.bind(name,function(event){handler.apply(self,[event,$element,data||{}])})})}}return $element},load:function(request,filters){request=request||this.data;if(request){this.trigger("loading",[true]);if(typeof request.ajax=="object"&&!$.isEmpty(request.ajax)){var self=this;filters=$.extend(true,{},this.filters,filters);var request=$.extend(true,{},request.ajax,{data:filters,cache:this.cache_requests,success:function(data){$.extend(true,data,request.json||{});self.trigger("post_load",[data])},error:function(){self.error("ajax",arguments)}});$.ajax(request)}else if(typeof request.json=="object"&&!$.isEmpty(request.json)){this.trigger("post_load",[request.json])}}},tabulate:function(data){var self=this,$row=this.fragments.$row.clone(),rows=$.getNestedKey(this.keys.rows,data)||{},columns=$.getNestedKey(this.keys.columns,data)||{};this.count=data[this.keys.count]||$.getLength(rows);this.total_pages=Math.ceil(this.count/this.filters.limit)||1;this.$head.empty();this.$body.empty();if($.isEmpty(rows)){this.error("tabulate",arguments)}else{$.each(this.columns,function(c,column){var c=($.isNumber(c)?parseInt(c)+1:c),$cell=self.fragments.$cell.clone(),$content=self.fragments.$content.clone(),properties=$.extend({},{args:[$row,$cell,$content],data:$.getNestedKey(c,columns),name:c,$content:$content},column.head);$cell.attr("id",self.name+"-column-"+c+"-head").addClass("column-"+c);self.set_properties($cell,properties);$row.append($cell.append($content))});$row.find("td:first").addClass("tabulate-cell-first");$row.find("td:last").addClass("tabulate-cell-last");this.$head.append($row);$.each(rows,function(r,row_data){var r=($.isNumber(r)?parseInt(r)+1:r),render=false,$row=self.fragments.$row.clone();$.each(self.columns,function(c,column_data){var c=($.isNumber(c)?parseInt(c)+1:c),$cell=self.fragments.$cell.clone(),$content=self.fragments.$content.clone(),properties=$.extend({},{data:row_data,args:[$row,$cell,$content,row_data],name:c,$content:$content},column_data.body);$cell.hover(function(){$(this).addClass("tabulate-cell-hover")},function(){$(this).removeClass("tabulate-cell-hover")});$cell.attr("id",self.name+"-column-"+c+"-body").data("location",{row:r,column:c}).addClass("column-"+c);self.set_properties($cell,properties);$row.append($cell.append($content));if(!render&&$content.html())render=true});if(render){var properties=$.extend({},{data:row_data,args:[$row,row_data],name:r},self.rows);$row.hover(function(){$(this).addClass("tabulate-row-hover")},function(){$(this).removeClass("tabulate-row-hover")});$row.find("td:first").addClass("tabulate-cell-first");$row.find("td:last").addClass("tabulate-cell-last");$row.attr("id",self.name+"-row-"+r).data("data",row_data);self.set_properties($row,properties);self.$body.append($row)}});this.$body.find("tr:odd").addClass("tabulate-row-odd");this.$body.find("tr:even").addClass("tabulate-row-even");this.$body.find("tr:first").addClass("tabulate-row-first");this.$body.find("tr:last").addClass("tabulate-row-last")}this.trigger("loading",[false]);this.trigger("post_tabulate",[data])},event_handlers:{refresh:function(event,data,filters){this.load(data||this.data,filters||{})},loading:function(event,bool){if(typeof bool=="boolean"){this.elements.$loading[(bool?"addClass":"removeClass")]("loading")}else{this.elements.$loading.toggleClass("loading")}},post_init:function(event){var self=this;this.$foot.find(".tabulate-cell").attr("colSpan",$.getLength(this.columns));$.each(this.results_per_page,function(i,value){self.elements.$results_per_page.append(self.fragments.$option.clone().val(value).text(value))});this.trigger("refresh")},post_load:function(even,data){this.tabulate(data)},post_tabulate:function(event,data){this.elements.$count.text(this.count);this.elements.$total_pages.text(this.total_pages);this.elements.$current_page.val(this.current_page)}},error_handlers:{ajax:function(XMLHttpRequest,textStatus,errorThrown){console.log(this.toString()+" Error: "+textStatus,XMLHttpRequest,errorThrown);alert(XMLHttpRequest.status+": "+(XMLHttpRequest.statusText||"Unknown error."))},tabulate:function(data){console.log(this.toString()+" Warning: '"+this.keys.rows+"' is empty or missing.")}}}})(jQuery);